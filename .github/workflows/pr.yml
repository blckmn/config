name: Check config files are valid

permissions:
  contents: read 
  pull-requests: read 

on:
  pull_request:
    branches:
      - master

jobs:
  # ----------------------------------------------------
  # JOB 1: Prepares the Matrix using a Marketplace Action
  # ----------------------------------------------------
  prepare_matrix:
    runs-on: ubuntu-latest
    
    outputs:
      changed_files_json: ${{ steps.changed_files.outputs.all_changed_files_json }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
          
      - name: Get Changed Files and Output JSON
        id: changed_files
        uses: tj-actions/changed-files@v44 
        with:
          json: true 
          files: |
            config/**

      - name: Display JSON Output (for debugging)
        run: |
          echo "Output JSON: ${{ steps.changed_files.outputs.all_changed_files_json }}"

  # ----------------------------------------------------
  # JOB 2: Runs the Matrix in Parallel
  # ----------------------------------------------------
  process_file:
    needs: prepare_matrix 
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(needs.prepare_matrix.outputs.changed_files_json) }}
        
    steps:
      - name: Checkout Config Code
        uses: actions/checkout@v4
        with:
          path: 'config'

      - name: Checkout Betaflight Repository (Shallow)
        uses: actions/checkout@v4
        with:
          repository: 'betaflight/betaflight' 
          path: 'firmware'
          fetch-depth: 1
      
      - name: Process File ${{ matrix.file }}
        run: |
          FILE_PATH="${{ matrix.file }}"
          
          echo "--- Running check on $FILE_PATH ---"
          ls -al
                    
